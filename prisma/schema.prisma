generator client {
  provider = "prisma-client-js"

}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Categorias {
  id        String      @id @default(uuid())
  createdAt DateTime    @default(now())
  nombre    String      @unique
  products  Productos[] @relation("CategoriasToProductos")
}

model Productos {
  id               String              @id @default(uuid())
  createdAt        DateTime            @default(now())
  codigoBarra      String              @unique
  nombre           String
  descripcion      String?
  imagen           String?
  tipoVenta        TipoVenta           @default(UNIDAD)
  stockSuelto      Int                 @default(0)
  puntoPedido      Int                 @default(0)
  size             Float?
  unidad           String?
  marcaId          String?
  marca            Contactos?          @relation("MarcaProducto", fields: [marcaId], references: [id])
  detalleDocumento DetalleDocumento[]
  precios          Precios[]
  proveedores      ProductoProveedor[]
  skuAliases       ProveedorSkuAlias[]
  categorias       Categorias[]        @relation("CategoriasToProductos")
  presentaciones   Presentaciones[]
  detallePedidos   DetallePedidos[]
  compraItems      CompraPedidoItem[]
}

model TiposPresentacion {
  id          String          @id @default(uuid())
  createdAt   DateTime        @default(now())
  nombre      String          @unique
  descripcion String?
  presentaciones Presentaciones[]
}

model Presentaciones {
  id                  String                  @id @default(uuid())
  createdAt           DateTime                @default(now())
  nombre              String
  codigoBarra          String?                 @unique
  productoId          String
  tipoPresentacionId  String
  cantidad            Float
  unidadMedida        String
  contenidoPorUnidad  Float?
  unidadContenido     String?
  precio              Float?
  descuento           Float                   @default(0)
  esUnidadBase        Boolean                 @default(false)
  // Operaciones permitidas sobre esta presentación
  puedeAbrir          Boolean                 @default(false)  // Se puede abrir/desempacar
  puedeCerrar         Boolean                 @default(false)  // Se puede cerrar/empacar
  puedeProducir       Boolean                 @default(false)  // Se puede producir/elaborar
  producto            Productos               @relation(fields: [productoId], references: [id], onDelete: Cascade)
  tipoPresentacion    TiposPresentacion      @relation(fields: [tipoPresentacionId], references: [id])
  contenidas          AgrupacionPresentaciones[] @relation("PresentacionContenida")
  contenedoras        AgrupacionPresentaciones[] @relation("PresentacionContenedora")
  stock               StockPresentacion?
  skuAliases          ProveedorSkuAlias[]
  compraItems         CompraPedidoItem[]
  detallePedidos      DetallePedidos[]
}

model StockPresentacion {
  id             String        @id @default(uuid())
  createdAt      DateTime      @default(now())
  presentacionId String        @unique
  stockCerrado   Int           @default(0)
  presentacion   Presentaciones @relation(fields: [presentacionId], references: [id], onDelete: Cascade)
}

model AgrupacionPresentaciones {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  presentacionContenidaId  String
  presentacionContenedoraId String
  cantidad                  Float
  presentacionContenida    Presentaciones  @relation("PresentacionContenida", fields: [presentacionContenidaId], references: [id], onDelete: Cascade)
  presentacionContenedora  Presentaciones  @relation("PresentacionContenedora", fields: [presentacionContenedoraId], references: [id], onDelete: Cascade)
  
  @@unique([presentacionContenidaId, presentacionContenedoraId])
}

model ProductoProveedor {
  createdAt   DateTime  @default(now())
  productoId  String
  proveedorId String
  codigo      String
  producto    Productos @relation(fields: [productoId], references: [id], onDelete: Cascade)
  proveedor   Contactos @relation(fields: [proveedorId], references: [id])
  @@id([proveedorId, productoId])
  @@unique([proveedorId, productoId])
}

model Precios {
  id         Int       @id @default(autoincrement())
  createdAt  DateTime  @default(now())
  precio     Float
  idProducto String
  producto   Productos @relation(fields: [idProducto], references: [id], onDelete: Cascade)
}

model Documentos {
  id              String             @id @default(uuid())
  createdAt       DateTime           @default(now())
  idContacto      String
  idDestinatario  String
  numeroDocumento String
  fecha           DateTime
  tieneImpuestos  Boolean            @default(false)
  idTipoDocumento String
  idEstadoDocumento String
  tipoDocumento   TiposDocumento    @relation(fields: [idTipoDocumento], references: [id])
  estadoDocumento EstadosDocumento  @relation(fields: [idEstadoDocumento], references: [id])
  tipoMovimiento  TipoMovimiento
  total           Float              @default(0)
  detalle         DetalleDocumento[]
  emisor          Contactos          @relation("EmisorDocumento", fields: [idContacto], references: [id])
  receptor        Contactos          @relation("ReceptorDocumento", fields: [idDestinatario], references: [id])
  pagos           Pagos[]
  imagen          String?

  @@unique([idContacto, numeroDocumento])
}

model DetalleDocumento {
  id             String     @id @default(uuid())
  createdAt      DateTime   @default(now())
  docRelacionado String
  idProducto     String
  cantidad       Float
  precioUnitario Float
  unidadVenta    String?
  variedad       String?
  documento      Documentos @relation(fields: [docRelacionado], references: [id], onDelete: Cascade)
  producto       Productos  @relation(fields: [idProducto], references: [id], onDelete: Cascade)
}

model Contactos {
  id                  String              @id @default(uuid())
  createdAt           DateTime            @default(now())
  cuit                String              @unique
  nombre              String              @unique
  telefono            String              @default("0800-completar-telefono")
  persona             String?
  iva                 String?
  esInterno           Boolean             @default(false)
  esProveedor         Boolean             @default(false)
  esMarca             Boolean             @default(false)
  nombreFantasia      String?             
  frecuenciaEntrega   FrecuenciaEntrega?
  diasEntrega         String[]            @default([])
  leadTimeDias        Int?
  direcciones         Direcciones[]
  documentosEmitidos  Documentos[]        @relation("EmisorDocumento")
  documentosRecibidos Documentos[]        @relation("ReceptorDocumento")
  emails              Emails[]
  productos           ProductoProveedor[]
  cuentaBancaria      CuentaBancaria[]
  pedidos             Pedidos[]           @relation("PedidoProveedor")
  productosMarca       Productos[]         @relation("MarcaProducto")

  compraPedidos       CompraPedido[]
  skuAliases          ProveedorSkuAlias[]
  compraItems         CompraPedidoItem[]
  aliases             AliasContacto[]     // Nombres alternativos para reconocimiento
}

model AliasContacto {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now())
  contactoId  String
  alias       String    @unique // El nombre alternativo (ej: nombre mal escaneado)
  fuente      FuenteAlias @default(MANUAL) // De dónde se originó el alias
  activo      Boolean   @default(true)
  observaciones String?
  creadoPor   String?   // ID del usuario que creó el alias
  contacto    Contactos @relation(fields: [contactoId], references: [id], onDelete: Cascade)
  
  @@index([contactoId])
  @@index([alias])
}

enum FuenteAlias {
  MANUAL      // Creado manualmente por usuario
  IA_SCAN     // Detectado por escaneo de IA
  IMPORTACION // Desde importación de datos
}

enum FrecuenciaEntrega {
  SEMANAL
  QUINCENAL
}

enum CompraEstadoPedido {
  BORRADOR
  PENDIENTE_SELECCION
  ENVIADO
  RECIBIDO
}

enum CorreccionPendienteEstado {
  ABIERTO
  RESUELTO
}

enum CorreccionPendienteTipo {
  MAPEAR_ITEM_FACTURA
  ALIAS_PRESENTACION_PROVEEDOR
  DATO_FALTANTE
}

model CorreccionPendiente {
  id              String                    @id @default(uuid())
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt

  estado          CorreccionPendienteEstado @default(ABIERTO)
  tipo            CorreccionPendienteTipo

  titulo          String
  descripcion     String?

  // Para poder filtrar/entender qué se debe arreglar
  entidadTipo     String?
  entidadId       String?
  contexto        String?

  // Datos para continuar sin cortar el flujo
  payload         Json?

  creadoPor       String?
  resueltoAt      DateTime?
  resueltoPor     String?
  notasResolucion String?

  @@index([estado])
  @@index([tipo])
  @@index([createdAt])
}

model ProveedorSkuAlias {
  id                String   @id @default(uuid())
  createdAt         DateTime @default(now())

  proveedorId       String
  productoId        String?
  presentacionId    String?

  sku               String
  nombreEnProveedor String?
  leadTimeDias      Int?
  esPreferido       Boolean  @default(false)

  proveedor         Contactos       @relation(fields: [proveedorId], references: [id])
  producto          Productos?      @relation(fields: [productoId], references: [id], onDelete: Cascade)
  presentacion      Presentaciones? @relation(fields: [presentacionId], references: [id], onDelete: Cascade)

  @@index([proveedorId])
  @@index([productoId])
  @@index([presentacionId])
  @@unique([proveedorId, sku])
  @@unique([proveedorId, presentacionId])
}

model CompraPedido {
  id          String            @id @default(uuid())
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Identificador humano
  numero      String            @unique
  fecha       DateTime          @default(now())

  // Pedido “inteligente” puede ser genérico (proveedorId null)
  proveedorId String?
  proveedor   Contactos?        @relation(fields: [proveedorId], references: [id])

  estado      CompraEstadoPedido @default(BORRADOR)
  notas       String?
  creadoPor   String?

  // Link opcional al Pedido real (tabla Pedidos) cuando se materializa
  pedidoId    String?

  items       CompraPedidoItem[]

  @@index([proveedorId])
  @@index([pedidoId])
}

model CompraPedidoItem {
  id               String   @id @default(uuid())
  createdAt        DateTime @default(now())

  compraPedidoId   String
  compraPedido     CompraPedido @relation(fields: [compraPedidoId], references: [id], onDelete: Cascade)

  proveedorId      String?
  proveedor        Contactos? @relation(fields: [proveedorId], references: [id])

  productoId       String
  producto         Productos @relation(fields: [productoId], references: [id])

  presentacionId   String?
  presentacion     Presentaciones? @relation(fields: [presentacionId], references: [id])

  proveedorSku      String?
  nombreEnProveedor String?

  // Snapshot de cálculo (visibilidad total)
  stockActual          Float?
  puntoPedido          Float?
  ventasPeriodo        Float?
  ventasPromDiaria     Float?
  leadTimeDias         Float?
  demandaLeadTime      Float?

  tendencia7dVsPrev7d  Float?
  tendenciaYoYMes      Float?
  externos             Json?

  cantidadSugerida     Float?
  cantidadFinal        Float?
  fueEditadoManual     Boolean @default(false)

  lastPurchasePrice    Float?

  @@index([compraPedidoId])
  @@index([proveedorId])
  @@index([productoId])
  @@index([presentacionId])
}

model Usuarios {
  id        String   @id @default(uuid())
  nombre    String   @unique
  password  String
  nivel     Int      @default(1)
  createdAt DateTime @default(now())
  email     String?  @unique
  pedidos   Pedidos[] @relation("PedidoUsuario")
  auditLogs AuditLog[]
}

model Emails {
  id         String    @id @default(uuid())
  email      String    @unique
  idContacto String
  contacto   Contactos @relation(fields: [idContacto], references: [id])
}

model Direcciones {
  id                String       @id @default(uuid())
  idContacto        String
  idProvincia       String?
  idLocalidad       String?
  depto             String?
  detalles          String?
  idCalle           String?
  idLocalidadCensal String?
  numeroCalle       Int?
  piso              String?
  calle             Calles?      @relation(fields: [idCalle], references: [id])
  contacto          Contactos    @relation(fields: [idContacto], references: [id])
  localidad         Localidades? @relation(fields: [idLocalidad], references: [id])
  provincia         Provincias?  @relation(fields: [idProvincia], references: [id])
}

model Provincias {
  id             String        @id
  nombre         String
  nombreCompleto String
  isoId          String
  calles         Calles[]
  Direcciones    Direcciones[]
  localidades    Localidades[]
}

model Localidades {
  id                    String        @id
  nombre                String
  idProvincia           String
  nombreLocalidadCensal String
  idDepartamento        String?
  idLocalidadCensal     String
  idMunicipio           String?
  Direcciones           Direcciones[]
  provincia             Provincias    @relation(fields: [idProvincia], references: [id])
}

model Calles {
  id                String        @id
  nombre            String
  categoria         String
  idProvincia       String
  alturas           String
  idLocalidadCensal String
  provincia         Provincias    @relation(fields: [idProvincia], references: [id])
  Direcciones       Direcciones[]
}

model CuentaBancaria {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  idContacto  String
  banco       String
  cbu         String
  alias       String
  contacto    Contactos @relation(fields: [idContacto], references: [id])
}

enum TipoMovimiento {
  ENTRADA
  SALIDA
}

enum TipoVenta {
  GRANEL
  UNIDAD
  BULTO
}

enum TipoDocumento {
  FACTURA_A
  FACTURA_B
  FACTURA_C
  REMITO
  PRESUPUESTO
  CONTEO
}

enum EstadoDocumento {
  IMPAGA
  PAGA
  PARCIAL
}

enum FormaPago {
  EFECTIVO
  TARJETA_CREDITO
  TARJETA_DEBITO
  TRANSFERENCIA
  CHEQUE
  CUENTA_CORRIENTE
}

enum EstadoPedido {
  PENDIENTE
  ENVIADO
  RECIBIDO
  CANCELADO
}

enum AuditLevel {
  INFO
  SUCCESS
  WARNING
  ERROR
  CRITICAL
}

enum AuditCategory {
  UI
  DB
  SYSTEM
  AUTH
  FILE
}

model Pedidos {
  id                String            @id @default(uuid())
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  numero            String            @unique
  fecha             DateTime
  idProveedor       String?
  proveedor         Contactos?        @relation("PedidoProveedor", fields: [idProveedor], references: [id])
  estado            EstadoPedido      @default(PENDIENTE)
  notas             String?
  idUsuario         String
  usuario           Usuarios          @relation("PedidoUsuario", fields: [idUsuario], references: [id])
  detallePedidos    DetallePedidos[]
}

model DetallePedidos {
  id            String      @id @default(uuid())
  createdAt     DateTime    @default(now())
  idPedido      String
  pedido        Pedidos     @relation(fields: [idPedido], references: [id], onDelete: Cascade)
  idProducto    String
  producto      Productos   @relation(fields: [idProducto], references: [id])
  presentacionId String?
  presentacion  Presentaciones? @relation(fields: [presentacionId], references: [id])
  cantidad      Float
  precioUnitario Float?
  observaciones String?

  @@unique([idPedido, idProducto, presentacionId])
}

model TiposDocumento {
  id          String      @id @default(uuid())
  createdAt   DateTime    @default(now())
  codigo      String      @unique
  nombre      String      @unique
  descripcion String?
  activo      Boolean     @default(true)
  documentos  Documentos[]
}

model EstadosDocumento {
  id          String      @id @default(uuid())
  createdAt   DateTime    @default(now())
  codigo      String      @unique
  nombre      String      @unique
  descripcion String?
  activo      Boolean     @default(true)
  documentos  Documentos[]
}

model Pagos {
  id            String     @id @default(uuid())
  createdAt     DateTime   @default(now())
  idDocumento   String
  documento     Documentos @relation(fields: [idDocumento], references: [id], onDelete: Cascade)
  formaPago     FormaPago
  monto         Float
  fechaPago     DateTime   @default(now())
  observaciones String?
}

model AuditLog {
  id        String       @id @default(uuid())
  createdAt DateTime     @default(now())
  userId    String?
  level     AuditLevel
  category  AuditCategory
  action    String
  message   String
  metadata  Json?
  path      String
  user      Usuarios?    @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([userId])
  @@index([level])
  @@index([category])
}
